<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Visual MCMC diagnostics using the bayesplot package • bayesplot</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">bayesplot</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Other Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="http://mc-stan.org/rstan">rstan</a>
    </li>
    <li>
      <a href="http://mc-stan.org/rstanarm">rstanarm</a>
    </li>
    <li>
      <a href="http://mc-stan.org/shinystan">shinystan</a>
    </li>
    <li>
      <a href="http://mc-stan.org/loo">loo</a>
    </li>
    <li>
      <a href="http://mc-stan.org/rstantools">rstantools</a>
    </li>
  </ul>
</li>
<li>
  <a href="http://mc-stan.org">Stan</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://twitter.com/mcmc_stan">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/stan-dev/bayesplot">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="http://discourse.mc-stan.org/">
    <span class="fa fa-users"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Visual MCMC diagnostics using the bayesplot package</h1>
                        <h4 class="author">Jonah Gabry</h4>
            
            <h4 class="date">2017-08-08</h4>
          </div>

    
    
<div class="contents">
<p>This vignette focuses on MCMC diagnostic plots. Plots of parameter estimates from MCMC draws and graphical posterior predictive checks are covered in separate vignettes.</p>
<p>In addition to <strong>bayesplot</strong> we’ll load the following packages:</p>
<ul>
<li>
<strong>ggplot2</strong> for customizing the ggplot objects created by <strong>bayesplot</strong>
</li>
<li>
<strong>rstan</strong> for fitting the example models used throughout the vignette</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">"bayesplot"</span>)
<span class="kw">library</span>(<span class="st">"ggplot2"</span>)
<span class="kw">library</span>(<span class="st">"rstan"</span>)      </code></pre></div>
<div id="general-mcmc-diagnostics" class="section level2">
<h2 class="hasAnchor">
<a href="#general-mcmc-diagnostics" class="anchor"></a>General MCMC diagnostics</h2>
<p>A Markov chain generates draws from the target distribution only after it has converged to equilibrium. Unfortunately, this is only guaranteed in the limit in theory. In practice, diagnostics must be applied to monitor whether the Markov chain(s) have converged. The <strong>bayesplot</strong> package provides various plotting functions for visualizing Markov chain Monte Carlo (MCMC) diagnostics after fitting a Bayesian model. MCMC draws from any package can be used with <strong>bayesplot</strong>, although there are a few diagnostic plots that are specifically intended to be used for <a href="http://mc-stan.org/">Stan</a> models.</p>
<p>To demonstrate, in this vignette we’ll use the eight schools example discussed in Rubin (1981), Gelman et al (2013), and the <a href="https://github.com/stan-dev/rstan/wiki/RStan-Getting-Started#how-to-use-rstan">RStan Getting Started</a> wiki. This is a simple hierarchical meta-analysis model with data consisting of point estimates <code>y</code> and standard errors <code>sigma</code> from analyses of test prep programs in <code>J=8</code> schools:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">schools_dat &lt;-<span class="st"> </span><span class="kw">list</span>(
  <span class="dt">J =</span> <span class="dv">8</span>, 
  <span class="dt">y =</span> <span class="kw">c</span>(<span class="dv">28</span>,  <span class="dv">8</span>, -<span class="dv">3</span>,  <span class="dv">7</span>, -<span class="dv">1</span>,  <span class="dv">1</span>, <span class="dv">18</span>, <span class="dv">12</span>),
  <span class="dt">sigma =</span> <span class="kw">c</span>(<span class="dv">15</span>, <span class="dv">10</span>, <span class="dv">16</span>, <span class="dv">11</span>,  <span class="dv">9</span>, <span class="dv">11</span>, <span class="dv">10</span>, <span class="dv">18</span>)
)</code></pre></div>
<p>The model is: <span class="math display">\[
\begin{align*}
y_j &amp;\sim {\rm Normal}(\theta_j, \sigma_j), \quad j = 1,\dots,J \\
\theta_j &amp;\sim {\rm Normal}(\mu, \tau), \quad j = 1, \dots, J \\
\mu &amp;\sim {\rm Normal}(0, 10) \\
\tau &amp;\sim {\rm half-Cauchy}(0, 10),
\end{align*}
\]</span> with the normal distribution parameterized by the mean and standard deviation, not the variance or precision. In Stan code:</p>
<pre class="stan"><code>// Saved in 'schools_mod_cp.stan'
data {
  int&lt;lower=0&gt; J;
  vector[J] y;
  vector&lt;lower=0&gt;[J] sigma;
}
parameters {
  real mu;
  real&lt;lower=0&gt; tau;
  vector[J] theta;
}
model {
  mu ~ normal(0, 10);
  tau ~ cauchy(0, 10);
  theta ~ normal(mu, tau);
  y ~ normal(theta, sigma);
}</code></pre>
<p>This parameterization of the model is referred to as the centered parameterization (CP). We’ll also fit the same statistical model but using the so-called non-centered parameterization (NCP), which replaces the vector <span class="math inline">\(\theta\)</span> with a vector <span class="math inline">\(\eta\)</span> of a priori <em>i.i.d.</em> standard normal parameters and then contructs <span class="math inline">\(\theta\)</span> deterministically from <span class="math inline">\(\eta\)</span> by scaling by <span class="math inline">\(\tau\)</span> and shifting by <span class="math inline">\(\mu\)</span>: <span class="math display">\[
\begin{align*}
\theta_j &amp;= \mu + \tau \,\eta_j, \quad j = 1,\dots,J \\
\eta_j &amp;\sim N(0,1), \quad j = 1,\dots,J.
\end{align*}
\]</span> The Stan code for this model is:</p>
<pre class="stan"><code>// Saved in 'schools_mod_ncp.stan'
data {
  int&lt;lower=0&gt; J;
  vector[J] y;
  vector&lt;lower=0&gt;[J] sigma;
}
parameters {
  real mu;
  real&lt;lower=0&gt; tau;
  vector[J] eta;
}
transformed parameters {
  vector[J] theta;
  theta = mu + tau * eta;
}
model {
  mu ~ normal(0, 10);
  tau ~ cauchy(0, 10);
  eta ~ normal(0, 1); // implies theta ~ normal(mu, tau)
  y ~ normal(theta, sigma);
}</code></pre>
<p>The centered and non-centered are two parameterizations of the same statistical model, but they have very different practical implications for MCMC. Using the <strong>bayesplot</strong> diagnostic plots, we’ll see that, for this data, the NCP is required in order to properly explore the posterior distribution.</p>
<p>To fit both models we first translate the Stan code to C++ and compile it using the <code>stan_model</code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">schools_mod_cp &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/rstan/topics/stan_model">stan_model</a></span>(<span class="st">"schools_mod_cp.stan"</span>)
schools_mod_ncp &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/rstan/topics/stan_model">stan_model</a></span>(<span class="st">"schools_mod_ncp.stan"</span>)</code></pre></div>
<p>We then fit the model by calling Stan’s MCMC algorithm using the <code>sampling</code> function,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit_cp &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/rstan/topics/stanmodel-method-sampling">sampling</a></span>(schools_mod_cp, <span class="dt">data =</span> schools_dat)</code></pre></div>
<pre><code>Warning: There were 135 divergent transitions after warmup. Increasing adapt_delta above 0.8 may help. See
http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</code></pre>
<pre><code>Warning: There were 1 chains where the estimated Bayesian Fraction of Missing Information was low. See
http://mc-stan.org/misc/warnings.html#bfmi-low</code></pre>
<pre><code>Warning: Examine the pairs() plot to diagnose sampling problems</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit_ncp &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/rstan/topics/stanmodel-method-sampling">sampling</a></span>(schools_mod_ncp, <span class="dt">data =</span> schools_dat)</code></pre></div>
<pre><code>Warning: There were 2 divergent transitions after warmup. Increasing adapt_delta above 0.8 may help. See
http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup

Warning: Examine the pairs() plot to diagnose sampling problems</code></pre>
<p>and extract a <code>iterations x chains x parameters</code> array of posterior draws with <code>as.array</code>,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Extract posterior draws for later use</span>
posterior_cp &lt;-<span class="st"> </span><span class="kw">as.array</span>(fit_cp)
posterior_ncp &lt;-<span class="st"> </span><span class="kw">as.array</span>(fit_ncp)</code></pre></div>
<p>For now ignore any warnings issued by the sampler. We will come back to them later in the <a href="#diagnostics-for-the%20no-u-turn-sampler">Diagnostics for the No-U-Turn Sampler</a> section.</p>
<div id="rhat-potential-scale-reduction-statistic" class="section level3">
<h3 class="hasAnchor">
<a href="#rhat-potential-scale-reduction-statistic" class="anchor"></a>Rhat: potential scale reduction statistic</h3>
<blockquote>
<p>One way to monitor whether a chain has converged to the equilibrium distribution is to compare its behavior to other randomly initialized chains. This is the motivation for the Gelman and Rubin (1992) potential scale reduction statistic, <span class="math inline">\(\hat{R}\)</span>. The <span class="math inline">\(\hat{R}\)</span> statistic measures the ratio of the average variance of samples within each chain to the variance of the pooled samples across chains; if all chains are at equilibrium, these will be the same and <span class="math inline">\(\hat{R}\)</span> will be one. If the chains have not converged to a common distribution, the <span class="math inline">\(\hat{R}\)</span> statistic will be greater than one. (Stan Development Team, 2016).</p>
</blockquote>
<p>The <strong>bayesplot</strong> package provides the functions <code>mcmc_rhat</code> and <code>mcmc_rhat_hist</code> for visualizing <span class="math inline">\(\hat{R}\)</span> estimates.</p>
<p>First we’ll quickly fit one of the models above again, this time intentionally using too few MCMC iterations. This should lead to some high <span class="math inline">\(\hat{R}\)</span> values.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit_cp_100iter &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/rstan/topics/stanmodel-method-sampling">sampling</a></span>(schools_mod_cp, <span class="dt">data =</span> schools_dat, 
                           <span class="dt">chains =</span> <span class="dv">2</span>, <span class="dt">iter =</span> <span class="dv">100</span>)</code></pre></div>
<pre><code>Warning: There were 2 divergent transitions after warmup. Increasing adapt_delta above 0.8 may help. See
http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</code></pre>
<pre><code>Warning: There were 1 chains where the estimated Bayesian Fraction of Missing Information was low. See
http://mc-stan.org/misc/warnings.html#bfmi-low</code></pre>
<pre><code>Warning: Examine the pairs() plot to diagnose sampling problems</code></pre>
<p><strong>bayesplot</strong> provides a generic <code>rhat</code> extractor function, currently with methods defined for models fit using the <strong>rstan</strong> and <strong>rstanarm</strong> packages. But regardless of how you fit your model, all <strong>bayesplot</strong> needs is a vector of <span class="math inline">\(\hat{R}\)</span> values.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rhats &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bayesplot-extractors.html">rhat</a></span>(fit_cp_100iter)
<span class="kw">print</span>(rhats)</code></pre></div>
<pre><code>      mu      tau theta[1] theta[2] theta[3] theta[4] theta[5] theta[6] 
1.550589 1.514685 1.411436 1.425552 1.498789 1.387745 1.330194 1.393952 
theta[7] theta[8]     lp__ 
1.534572 1.421231 1.484684 </code></pre>
<p>We can visualize the <span class="math inline">\(\hat{R}\)</span> values with the <code>mcmc_rhat</code> function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/bayesplot-colors.html">color_scheme_set</a></span>(<span class="st">"brightblue"</span>) <span class="co"># see help("color_scheme_set")</span>
<span class="kw"><a href="../reference/MCMC-diagnostics.html">mcmc_rhat</a></span>(rhats)</code></pre></div>
<p><img src="MCMC-diagnostics_files/figure-html/mcmc_rhat-1-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>In the plot, the points representing the <span class="math inline">\(\hat{R}\)</span> values are colored based on whether they are less than <span class="math inline">\(1.05\)</span>, between <span class="math inline">\(1.05\)</span> and <span class="math inline">\(1.1\)</span>, or greater than <span class="math inline">\(1.1\)</span>.</p>
<p>The axis <span class="math inline">\(y\)</span>-axis text is off by default for this plot because it’s only possible to see the labels clearly for models with very few parameters. We can see the names of the parameters with the concerning <span class="math inline">\(\hat{R}\)</span> values using the <code>yaxis_text</code> convenience function (which passes arguments like <code>hjust</code> to <code><a href="http://www.rdocumentation.org/packages/ggplot2/topics/element">ggplot2::element_text</a></code>):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/MCMC-diagnostics.html">mcmc_rhat</a></span>(rhats) +<span class="st"> </span><span class="kw"><a href="../reference/bayesplot-helpers.html">yaxis_text</a></span>(<span class="dt">hjust =</span> <span class="dv">1</span>)</code></pre></div>
<p><img src="MCMC-diagnostics_files/figure-html/mcmc_rhat-2-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>If we look at the same model fit using longer Markov chains we should see all <span class="math inline">\(\hat{R} &lt; 1.1\)</span>, and all points in the plot the same (light) color:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/MCMC-diagnostics.html">mcmc_rhat</a></span>(<span class="dt">rhat =</span> <span class="kw"><a href="../reference/bayesplot-extractors.html">rhat</a></span>(fit_cp)) +<span class="st"> </span><span class="kw"><a href="../reference/bayesplot-helpers.html">yaxis_text</a></span>(<span class="dt">hjust =</span> <span class="dv">0</span>)</code></pre></div>
<p><img src="MCMC-diagnostics_files/figure-html/mcmc_rhat-3-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>We can see the same information shown by <code>mcmc_rhat</code> but in histogram form using the <code>mcmc_rhat_hist</code> function. See the <strong>Examples</strong> section in <code>help("mcmc_rhat_hist")</code> for examples.</p>
</div>
<div id="effective-sample-size" class="section level3">
<h3 class="hasAnchor">
<a href="#effective-sample-size" class="anchor"></a>Effective sample size</h3>
<p>The effective sample size is an estimate of the number of independent draws from the posterior distribution of the estimand of interest. Because the draws within a Markov chain are <em>not</em> independent if there is autocorrelation, the effective sample size, <span class="math inline">\(n_{eff}\)</span>, will be smaller than the total sample size, <span class="math inline">\(N\)</span>. The larger the ratio of <span class="math inline">\(n_{eff}\)</span> to <span class="math inline">\(N\)</span> the better.</p>
<p>The <strong>bayesplot</strong> package provides a generic <code>neff_ratio</code> extractor function, currently with methods defined for models fit using the <strong>rstan</strong> and <strong>rstanarm</strong> packages. But regardless of how you fit your model, all <strong>bayesplot</strong> needs is a vector of <span class="math inline">\(n_{eff}/N\)</span> values. The <code>mcmc_neff</code> and <code>mcmc_neff_hist</code> can then be used to plot the ratios.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ratios_cp &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bayesplot-extractors.html">neff_ratio</a></span>(fit_cp)
<span class="kw">print</span>(ratios_cp)</code></pre></div>
<pre><code>        mu        tau   theta[1]   theta[2]   theta[3]   theta[4] 
0.15458075 0.06198422 0.18352305 0.26519496 0.31695215 0.26528783 
  theta[5]   theta[6]   theta[7]   theta[8]       lp__ 
0.27797910 0.34409370 0.14860607 0.33880252 0.02398288 </code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/MCMC-diagnostics.html">mcmc_neff</a></span>(ratios_cp, <span class="dt">size =</span> <span class="dv">2</span>)</code></pre></div>
<p><img src="MCMC-diagnostics_files/figure-html/print-neff-ratios-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>In the plot, the points representing the values of <span class="math inline">\(n_{eff}/N\)</span> are colored based on whether they are less than <span class="math inline">\(0.1\)</span>, between <span class="math inline">\(0.1\)</span> and <span class="math inline">\(0.5\)</span>, or greater than <span class="math inline">\(0.5\)</span>. These particular values are arbitrary in that they have no particular theoretical meaning, but a useful heuristic is to worry about any <span class="math inline">\(n_{eff}/N\)</span> less than <span class="math inline">\(0.1\)</span>.</p>
<p>One important thing to keep in mind is that these ratios will depend not only on the model being fit but also on the particular MCMC algorithm used. One reason why we have such high ratios of <span class="math inline">\(n_{eff}\)</span> to <span class="math inline">\(N\)</span> is that the No-U-Turn sampler used by <strong>rstan</strong> generally produces draws from the posterior distribution with much lower autocorrelations compared to draws obtained using other MCMC algorithms (e.g., Gibbs).</p>
<p>Even for models fit using <strong>rstan</strong> the parameterization can make a big difference. Here are the <span class="math inline">\(n_{eff}/N\)</span> plots for <code>fit_cp</code> and <code>fit_ncp</code> side by side.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># A function we'll use several times to plot comparisons of the centered </span>
<span class="co"># parameterization (cp) and the non-centered parameterization (ncp). See</span>
<span class="co"># help("bayesplot_grid") for details on the bayesplot_grid function used here.</span>
compare_cp_ncp &lt;-<span class="st"> </span>function(cp_plot, ncp_plot, <span class="dt">ncol =</span> <span class="dv">2</span>) {
  <span class="kw"><a href="../reference/bayesplot_grid.html">bayesplot_grid</a></span>(
    cp_plot, ncp_plot, 
    <span class="dt">grid_args =</span> <span class="kw">list</span>(<span class="dt">ncol =</span> ncol),
    <span class="dt">subtitles =</span> <span class="kw">c</span>(<span class="st">"Centered parameterization"</span>, 
                  <span class="st">"Non-centered parameterization"</span>)
  )
}

neff_cp &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bayesplot-extractors.html">neff_ratio</a></span>(fit_cp, <span class="dt">pars =</span> <span class="kw">c</span>(<span class="st">"theta"</span>, <span class="st">"mu"</span>, <span class="st">"tau"</span>))
neff_ncp &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bayesplot-extractors.html">neff_ratio</a></span>(fit_ncp, <span class="dt">pars =</span> <span class="kw">c</span>(<span class="st">"theta"</span>, <span class="st">"mu"</span>, <span class="st">"tau"</span>))
<span class="kw">compare_cp_ncp</span>(<span class="kw"><a href="../reference/MCMC-diagnostics.html">mcmc_neff</a></span>(neff_cp), <span class="kw"><a href="../reference/MCMC-diagnostics.html">mcmc_neff</a></span>(neff_ncp), <span class="dt">ncol =</span> <span class="dv">1</span>)</code></pre></div>
<p><img src="MCMC-diagnostics_files/figure-html/mcmc_neff-compare-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>Because of the difference in parameterization, the effective sample sizes are much better for the second model, the non-centered parameterization.</p>
</div>
<div id="autocorrelation" class="section level3">
<h3 class="hasAnchor">
<a href="#autocorrelation" class="anchor"></a>Autocorrelation</h3>
<p>As mentioned above, <span class="math inline">\(n_{eff}/N\)</span> decreases as autocorrelation becomes more extreme. We can visualize the autocorrelation using the <code>mcmc_acf</code> (line plot) or <code>mcmc_acf_bar</code> (bar plot) functions. For the selected parameters, these functions show the autocorrelation for each Markov chain separately up to a user-specified number of lags.</p>
<p>Here we can again see a difference when comparing the two parameterizations of the same model. For model 1, <span class="math inline">\(\theta_1\)</span> is the primitive parameter for school 1, whereas for the non-centered parameterization in model 2 the primitive parameter is <span class="math inline">\(\eta_1\)</span> (and <span class="math inline">\(\theta_1\)</span> is later constructed from <span class="math inline">\(\eta_1\)</span>, <span class="math inline">\(\mu\)</span>, and <span class="math inline">\(\tau\)</span>):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">compare_cp_ncp</span>(
  <span class="kw"><a href="../reference/MCMC-diagnostics.html">mcmc_acf</a></span>(posterior_cp, <span class="dt">pars =</span> <span class="st">"theta[1]"</span>, <span class="dt">lags =</span> <span class="dv">10</span>),
  <span class="kw"><a href="../reference/MCMC-diagnostics.html">mcmc_acf</a></span>(posterior_ncp, <span class="dt">pars =</span> <span class="st">"eta[1]"</span>, <span class="dt">lags =</span> <span class="dv">10</span>)
)</code></pre></div>
<p><img src="MCMC-diagnostics_files/figure-html/mcmc_acf-1.png" width="60%" style="display: block; margin: auto;"></p>
</div>
</div>
<div id="diagnostics-for-the-no-u-turn-sampler" class="section level2">
<h2 class="hasAnchor">
<a href="#diagnostics-for-the-no-u-turn-sampler" class="anchor"></a>Diagnostics for the No-U-Turn Sampler</h2>
<p>The No-U-Turn Sampler (NUTS, Hoffman and Gelman, 2014) is the variant of Hamiltonian Monte Carlo (HMC) used by <a href="http://mc-stan.org/">Stan</a> and the various R packages that depend on Stan for fitting Bayesian models.</p>
<p>The <strong>bayesplot</strong> package has special functions for visualizing some of the unique diagnostics permitted by HMC, and NUTS in particular. See Betancourt (2017), Betancourt and Girolami (2013), and Stan Development Team (2016) for more details on the concepts.</p>
<p>The special <strong>bayesplot</strong> functions for NUTS diagnostics are</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/available_ppc.html">available_mcmc</a></span>(<span class="dt">pattern =</span> <span class="st">"_nuts_"</span>)</code></pre></div>
<pre><code>bayesplot MCMC module:
(matching pattern '_nuts_') 
  mcmc_nuts_acceptance
  mcmc_nuts_divergence
  mcmc_nuts_energy
  mcmc_nuts_stepsize
  mcmc_nuts_treedepth</code></pre>
<p>The <strong>bayesplot</strong> package also provides generic functions <code>log_posterior</code> and <code>nuts_params</code> for extracting the required information for the plots from fitted model objects. Currently methods are provided for models fit using the <strong>rstan</strong> and <strong>rstanarm</strong> packages, although it is not difficult to define additional methods for the objects returned by other R packages. For the Stan models we fit above we can use the <code>log_posterior</code> and <code>nuts_params</code> methods for stanfit objects:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">lp_cp &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bayesplot-extractors.html">log_posterior</a></span>(fit_cp)
<span class="kw">head</span>(lp_cp)</code></pre></div>
<pre><code>  Iteration     Value Chain
1         1 -28.68456     1
2         2 -24.63600     1
3         3 -21.00482     1
4         4 -20.16974     1
5         5 -17.63563     1
6         6 -15.50722     1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">np_cp &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bayesplot-extractors.html">nuts_params</a></span>(fit_cp)
<span class="kw">head</span>(np_cp)</code></pre></div>
<pre><code>  Iteration     Parameter     Value Chain
1         1 accept_stat__ 0.7253488     1
2         2 accept_stat__ 0.8979986     1
3         3 accept_stat__ 0.9920269     1
4         4 accept_stat__ 0.9364180     1
5         5 accept_stat__ 0.9881373     1
6         6 accept_stat__ 0.9967914     1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># for the second model</span>
lp_ncp &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bayesplot-extractors.html">log_posterior</a></span>(fit_ncp)
np_ncp &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bayesplot-extractors.html">nuts_params</a></span>(fit_ncp)</code></pre></div>
<div id="divergent-transitions" class="section level3">
<h3 class="hasAnchor">
<a href="#divergent-transitions" class="anchor"></a>Divergent transitions</h3>
<p>When running the Stan models at the beginning of this vignette there were warnings about divergent transitions. For an explanation of these warnings see <a href="http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup">Divergent transitions after warmup</a>.</p>
<p>The <code>divergences</code> argument to the <code>mcmc_trace</code> function can be used to add a rug plot (in red) of the divergences to a trace plot of parameter draws. Typically we can see that at least one of the chains is getting stuck wherever there is a cluster of many red marks:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/bayesplot-colors.html">color_scheme_set</a></span>(<span class="st">"mix-brightblue-gray"</span>)
<span class="kw"><a href="../reference/MCMC-traces.html">mcmc_trace</a></span>(posterior_cp, <span class="dt">pars =</span> <span class="st">"tau"</span>, <span class="dt">divergences =</span> np_cp) +<span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">xlab</a></span>(<span class="st">"Post-warmup iteration"</span>)</code></pre></div>
<p><img src="MCMC-diagnostics_files/figure-html/mcmc_trace-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>To look deeper at the information conveyed by the divergences we can use the <code>mcmc_nuts_divergence</code> function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/bayesplot-colors.html">color_scheme_set</a></span>(<span class="st">"red"</span>)
<span class="kw"><a href="../reference/MCMC-nuts.html">mcmc_nuts_divergence</a></span>(np_cp, lp_cp)</code></pre></div>
<p><img src="MCMC-diagnostics_files/figure-html/mcmc_nuts_divergence-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>In the top panel we see the distribution of the log-posterior when there was no divergence vs the distribution when there was a divergence. Divergences often indicate that some part of the posterior isn’t being explored and the plot confirms that <code>lp|Divergence</code> indeed has lighter tails than <code>lp|No divergence</code>.</p>
<p>The bottom panel shows the same thing but instead of the log-posterior the NUTS acceptance statistic is shown.</p>
<p>Specifying the optional <code>chain</code> argument will overlay the plot just for a particular Markov chain on the plot for all chains combined:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/MCMC-nuts.html">mcmc_nuts_divergence</a></span>(np_cp, lp_cp, <span class="dt">chain =</span> <span class="dv">4</span>)</code></pre></div>
<p><img src="MCMC-diagnostics_files/figure-html/mcmc_nuts_divergence-chain-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>For the non-centered parameterization we may get a few warnings about divergences but if we do we’ll have far fewer of them to worry about.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/MCMC-nuts.html">mcmc_nuts_divergence</a></span>(np_ncp, lp_ncp)</code></pre></div>
<p><img src="MCMC-diagnostics_files/figure-html/mcmc_nuts_divergence-2-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>If there are only a few divergences we can often get rid of them by increasing the target acceptance rate (<code>adapt_delta</code>), which has the effect of lowering the stepsize used by the sampler and allowing the Markov chains to explore more complicated curvature in the target distribution.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit_cp_2 &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/rstan/topics/stanmodel-method-sampling">sampling</a></span>(schools_mod_cp, <span class="dt">data =</span> schools_dat,
                     <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">adapt_delta =</span> <span class="fl">0.99</span>))</code></pre></div>
<pre><code>Warning: There were 6 divergent transitions after warmup. Increasing adapt_delta above 0.99 may help. See
http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</code></pre>
<pre><code>Warning: There were 596 transitions after warmup that exceeded the maximum treedepth. Increase max_treedepth above 10. See
http://mc-stan.org/misc/warnings.html#maximum-treedepth-exceeded</code></pre>
<pre><code>Warning: There were 4 chains where the estimated Bayesian Fraction of Missing Information was low. See
http://mc-stan.org/misc/warnings.html#bfmi-low</code></pre>
<pre><code>Warning: Examine the pairs() plot to diagnose sampling problems</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit_ncp_2 &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/rstan/topics/stanmodel-method-sampling">sampling</a></span>(schools_mod_ncp, <span class="dt">data =</span> schools_dat,
                      <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">adapt_delta =</span> <span class="fl">0.99</span>))</code></pre></div>
<p>For the first model and this particular data, increasing <code>adapt_delta</code> will not solve the problem and a reparameterization is required.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/MCMC-nuts.html">mcmc_nuts_divergence</a></span>(<span class="kw"><a href="../reference/bayesplot-extractors.html">nuts_params</a></span>(fit_cp_2), <span class="kw"><a href="../reference/bayesplot-extractors.html">log_posterior</a></span>(fit_cp_2))</code></pre></div>
<p><img src="MCMC-diagnostics_files/figure-html/mcmc_nuts_divergence-3-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/MCMC-nuts.html">mcmc_nuts_divergence</a></span>(<span class="kw"><a href="../reference/bayesplot-extractors.html">nuts_params</a></span>(fit_ncp_2), <span class="kw"><a href="../reference/bayesplot-extractors.html">log_posterior</a></span>(fit_ncp_2))</code></pre></div>
<p><img src="MCMC-diagnostics_files/figure-html/mcmc_nuts_divergence-3-2.png" width="60%" style="display: block; margin: auto;"></p>
</div>
<div id="energy-and-bayesian-fraction-of-missing-information" class="section level3">
<h3 class="hasAnchor">
<a href="#energy-and-bayesian-fraction-of-missing-information" class="anchor"></a>Energy and Bayesian fraction of missing information</h3>
<p>The <code>mcmc_nuts_energy</code> function creates plots similar to those presented in Betancourt (2017). While <code>mcmcm_nuts_divergence</code> can identify light tails and incomplete exploration of the target distribution, the <code>mcmc_nuts_energy</code> function can identify overly heavy tails that are also challenging for sampling. Informally, the energy diagnostic for HMC (and the related energy-based Bayesian fraction of missing information) quantifies the heaviness of the tails of the posterior distribution.</p>
<p>The plot created by <code>mcmc_nuts_energy</code> shows overlaid histograms of the (centered) marginal energy distribution <span class="math inline">\(\pi_E\)</span> and the first-differenced distribution <span class="math inline">\(\pi_{\Delta E}\)</span>,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/MCMC-nuts.html">mcmc_nuts_energy</a></span>(np_cp)</code></pre></div>
<p><img src="MCMC-diagnostics_files/figure-html/mcmc_nuts_energy-1-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>The two histograms ideally look the same (Betancourt, 2017), which is only the case for the non-centered parameterization (right):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">compare_cp_ncp</span>(
  <span class="kw"><a href="../reference/MCMC-nuts.html">mcmc_nuts_energy</a></span>(np_cp, <span class="dt">binwidth =</span> <span class="dv">1</span>/<span class="dv">2</span>),
  <span class="kw"><a href="../reference/MCMC-nuts.html">mcmc_nuts_energy</a></span>(np_ncp, <span class="dt">binwidth =</span> <span class="dv">1</span>/<span class="dv">2</span>)
)</code></pre></div>
<p><img src="MCMC-diagnostics_files/figure-html/mcmc_nuts_energy-3-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>The difference between the parameterizations is even more apparent if we force the stepsize to a smaller value and help the chains explore more of the posterior:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">np_cp_2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bayesplot-extractors.html">nuts_params</a></span>(fit_cp_2)
np_ncp_2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bayesplot-extractors.html">nuts_params</a></span>(fit_ncp_2)

<span class="kw">compare_cp_ncp</span>(
  <span class="kw"><a href="../reference/MCMC-nuts.html">mcmc_nuts_energy</a></span>(np_cp_2), 
  <span class="kw"><a href="../reference/MCMC-nuts.html">mcmc_nuts_energy</a></span>(np_ncp_2)
)</code></pre></div>
<p><img src="MCMC-diagnostics_files/figure-html/mcmc_nuts_energy-4-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>See Betancourt (2017) for more on this particular example as well as the general theory behind the energy plots.</p>
</div>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<p>Betancourt, M. (2017). A conceptual introduction to Hamiltonian Monte Carlo. <a href="https://arxiv.org/abs/1701.02434" class="uri">https://arxiv.org/abs/1701.02434</a></p>
<p>Betancourt, M. (2016). Diagnosing suboptimal cotangent disintegrations in Hamiltonian Monte Carlo. <a href="https://arxiv.org/abs/1604.00695" class="uri">https://arxiv.org/abs/1604.00695</a></p>
<p>Betancourt, M. and Girolami, M. (2013). Hamiltonian Monte Carlo for hierarchical models. <a href="https://arxiv.org/abs/1312.0906" class="uri">https://arxiv.org/abs/1312.0906</a></p>
<p>Gabry, J., and Goodrich, B. (2017). rstanarm: Bayesian Applied Regression Modeling via Stan. R package version 2.15.3. <a href="http://mc-stan.org/users/interfaces/rstanarm.html" class="uri">http://mc-stan.org/users/interfaces/rstanarm.html</a>, <a href="https://CRAN.R-project.org/package=rstanarm" class="uri">https://CRAN.R-project.org/package=rstanarm</a></p>
<p>Gelman, A. and Rubin, D. B. (1992). Inference from iterative simulation using multiple sequences. <em>Statistical Science</em>. 7(4): 457–472.</p>
<p>Gelman, A., Carlin, J. B., Stern, H. S., Dunson, D. B., Vehtari, A., and Rubin, D. B. (2013). <em>Bayesian Data Analysis</em>. Chapman &amp; Hall/CRC Press, London, third edition.</p>
<p>Hoffman, M. D. and Gelman, A. (2014). The No-U-Turn Sampler: adaptively setting path lengths in Hamiltonian Monte Carlo. <em>Journal of Machine Learning Research</em>. 15:1593–1623.</p>
<p>Rubin, D. B. (1981). Estimation in Parallel Randomized Experiments. <em>Journal of Educational and Behavioral Statistics</em>. 6:377–401.</p>
<p>Stan Development Team. (2017). <em>Stan Modeling Language Users Guide and Reference Manual</em>. <a href="http://mc-stan.org/users/documentation/" class="uri">http://mc-stan.org/users/documentation/</a></p>
<p>Stan Development Team. (2017). RStan: the R interface to Stan. R package version 2.16.2. <a href="http://mc-stan.org/users/interfaces/rstan.html" class="uri">http://mc-stan.org/users/interfaces/rstan.html</a>, <a href="https://CRAN.R-project.org/package=rstanarm" class="uri">https://CRAN.R-project.org/package=rstanarm</a></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#general-mcmc-diagnostics">General MCMC diagnostics</a></li>
      <li><a href="#diagnostics-for-the-no-u-turn-sampler">Diagnostics for the No-U-Turn Sampler</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Jonah Gabry.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
